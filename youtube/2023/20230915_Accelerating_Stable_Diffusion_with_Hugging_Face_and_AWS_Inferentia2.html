<!DOCTYPE html>

<html lang="en">
<head>
<meta content="Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - In this video, I show you how to accelerate Stable Diffusion and Stable Diffusion XL inference with the Hugging Face Optimum Neuron library and AWS Inferentia 2..." name="description"/><meta content="Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - Julien Simon" property="og:title"/><meta content="Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - In this video, I show you how to accelerate Stable Diffusion and Stable Diffusion XL inference with the Hugging Face Optimum Neuron library and AWS Inferentia 2..." property="og:description"/><meta content="https://www.julien.org/youtube/2023/20230915_Accelerating_Stable_Diffusion_with_Hugging_Face_and_AWS_Inferentia2.html" property="og:url"/><meta content="video" property="og:type"/><meta content="summary_large_image" name="twitter:card"/><meta content="Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - Julien Simon" name="twitter:title"/><meta content="Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - In this video, I show you how to accelerate Stable Diffusion and Stable Diffusion XL inference with the Hugging Face Optimum Neuron library and AWS Inferentia 2..." name="twitter:description"/><link href="https://www.julien.org/youtube/2023/20230915_Accelerating_Stable_Diffusion_with_Hugging_Face_and_AWS_Inferentia2.html" rel="canonical"/><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2 - Julien Simon</title>

<!-- Umami Analytics -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="27550dad-d418-4f5d-ad1b-dab573da1020"></script>
<link rel="dns-prefetch" href="//cloud.umami.is">
<style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .date {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 500;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            margin-bottom: 30px;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        .description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            white-space: pre-wrap;
            font-size: 1em;
        }
        .description a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .description a:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        .transcript {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            white-space: pre-wrap;
            font-size: 1em;
        }
        .transcript h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .tags {
            margin-bottom: 30px;
        }
        .tags h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }
        .links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .link {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .link:hover {
            background: #2980b9;
        }
        .link.youtube {
            background: #e74c3c;
        }
        .link.youtube:hover {
            background: #c0392b;
        }
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 1.8em;
            }
            .links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container">
<h1>Accelerating Stable Diffusion with Hugging Face and AWS Inferentia2</h1>
<div class="date">September 15, 2023</div>
<div class="video-container">
<iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" src="https://www.youtube.com/embed/-YFVlu5bqsg">
</iframe>
</div>
<div class="description">In this video, I show you how to accelerate Stable Diffusion and Stable Diffusion XL inference with the Hugging Face Optimum Neuron library and AWS Inferentia 2.

A few lines of code is all it takes, and of course, we run some benchmarks.

⭐️⭐️⭐️ Don't forget to subscribe to be notified of future videos ⭐️⭐️⭐️ 

- Amazon EC2 Inf2: <a href="https://aws.amazon.com/ec2/instance-types/inf2/" rel="noopener noreferrer" target="_blank">https://aws.amazon.com/ec2/instance-types/inf2/</a> 
- Optimum Neuron documentation: <a href="https://huggingface.co/docs/optimum-neuron" rel="noopener noreferrer" target="_blank">https://huggingface.co/docs/optimum-neuron</a>
- Optimum Neuron Github: <a href="https://github.com/huggingface/optimum-neuron" rel="noopener noreferrer" target="_blank">https://github.com/huggingface/optimum-neuron</a>
- Code: <a href="https://github.com/juliensimon/huggingface-demos/tree/main/optimum/neuron/sd" rel="noopener noreferrer" target="_blank">https://github.com/juliensimon/huggingface-demos/tree/main/optimum/neuron/sd</a></div>
<div class="transcript">
<h2>Transcript</h2>
            Hi everybody, this is Julien from Arcee. In this video, we're going to continue exploring hardware acceleration with AWS Inferentia 2. We'll zoom in on image generation with Stable Diffusion and Stable Diffusion XL, which we released three days ago. Let's get started.

If you're not familiar with AWS Inferentia 2, I recommend that you go and read a little bit about it. It's a custom accelerator designed by AWS to accelerate inference for large models like transformers and diffusers. You may want to look at the Neuron SDK, which is the SDK for inference, and Tranium, the custom accelerator for training. This has a lot of good information on model architectures that are supported, the roadmap for future models, which is actually public, performance tips, and more. So that's a good read.

In this demo, I will be using our own open-source library for hardware acceleration, called Optimum and Optimum Neuron, the library for Tranium and Inferentia. You'll find the release information, the models we support, and more. All right, so let's get going.

Here I've launched an Inf2 instance on AWS using the Neuron AMI built by AWS with the SDK and the tooling, etc. I've only installed Optimum Neuron on top of that. I'm using a larger instance because I'm running all kinds of benchmarks, but you could absolutely do this with Inf2XL, which is the smallest one, and we'll look at the price. So the workflow is very simple. First, we need to download a model from the Hub and compile it, convert it for Inferentia 2. You can do this with code or with the CLI. I'm going to show you both.

Let's look first at StableDiffusion where I use the code. As you will see, this is really very simple. If you are working with the diffusers library, you would simply create a stable diffusion pipeline and work with that. If you want to try out Inferentia, you would install Optimum Neuron and replace your stable diffusion pipeline with Neuron stable diffusion pipeline, just like this. Point at the model, define the batch size and the shape of the images you want to generate. If you need multiple image sizes or multiple batch sizes, then obviously you can build different pipelines for that. Next, I will simply download the model and let Optimum Neuron compile it for Inferentia 2 and save it to local disk. You need to do the compilation once, that's why I'm saving it. This takes about a minute for stable diffusion. I've already done it. We see the output of that here.

So now we have a model that can run on Inferentia. Again, this is the code version. I'll show you the CLI with Stable Diffusion XL. So how about generation? Generation is simple too. We create a neuron-stable-diffusion pipeline using the compiled model this time. We select the devices, the neuron devices we want to run this on. As you can see on this instance, I have 12 neuron devices and so 24 cores. I could run 12 pipelines if I wanted for different models, different image sizes, etc. Here I'm just going to be using one. Then I prompt the model, warm up once, and run 10 iterations and measure the time. Let's see how we do on this.

We're going to see the model being loaded on the first two devices here, the first two cores. And we should see some blinking lights pretty quickly. Yes, that's the warm-up. If you press F in Neur on top, you can switch between utilization and teraflops. That'll keep you busy until the images are generated. That should be 2 and something seconds. Let's see how we do. 2.46. So 2.46 is a good time for stable diffusion generation. If we go and look at this nice blog post, and as usual, I'll put all the links in the video description, we'll see that this post generates at 2.42 seconds. So that's good that we can actually reproduce the blog post. When it comes to cost, as mentioned, you could run this on the smallest inf2 instance, which would cost you 76 cents an hour, but I routinely launch those as spot instances where I spend 26 cents an hour. So the price per image that you see here can easily be divided by three. If you generate in 2.4 seconds, 2.5, you can generate maybe 1,200, 1,300 images per hour at a very, very low price. This is certainly more competitive than what you could do on GPU instances. But I'll let you check and come to your own conclusions.

Okay, this is stable diffusion. How about we try stable diffusion XL? This time I will show you how to use our CLI to export the model if that's your preferred way. We just use the Optimum CLI command line, which is part of the Optimum library, export to neuron, model name, the task type, and then batch size, height, width, and where you want to save. We force this to make sure we are using BF16, which is natively supported by Inferentia. Exporting is very simple. In the case of StableDiffusionXL, it takes about an hour. So make sure you save the model because you do not want to run this again and again for no reason. When it comes to generating, it is almost the same. The only difference is you need to use the StableDiffusion XL pipeline, not the StableDiffusion pipeline. And of course, I made that mistake. Load the model from disk, specify the device IDs. Let's try two devices first, and we'll see what we can do with more. The rest is the same. Warm up, predict 10 times. All right. Let's run this thing.

This will be a little longer because the model is a little bigger. So it needs about maybe 30 seconds to load. And then it's going to start predicting. OK, so I'll pause the video and I'll see you in a minute or so. All right, so it looks like we're predicting in 13, 14 seconds, something like that. We can see the two cores are very, very busy. This is a big model. So maybe adding more cores will help. Let's see. Okay, maybe one more. Two more. Lost count. Okay, 15.6. So now let's try, which is good, but let's see if we can do better with a few more devices. OK, so let's run this again, and we'll see. Reference time, 15.6. So it looks like we're a little faster. Yes, 13 seconds. The call was not super busy, but if I read this message, I think it tells me why. Because I'm using a batch size of 1, and that's harder to split across different cores. So working with larger batch sizes would probably give me even better performance. But still, I can generate it in 13 seconds. And this is good. As mentioned before, this is very, very cost-effective.

If you want to dive deeper, I would recommend checking this out on the Neuron SDK documentation, data parallel inference. It goes into using multiple cores, working with batch sizes, and doing dynamic batching and some other techniques, which you can apply with Optimum Neuron and make the most out of a chip. So there you go. Fast, cost-effective, interactive, simple, what's not to like. Give it a try. Let us know what you think. And I hope this was useful. There's certainly more content coming. Maybe I'll see you on the road. I'm touring EMEA right now. So come and say hi if you're around. And until next time, keep rocking.
        </div>
<div class="tags">
<h2>Tags</h2>
<span class="tag">AWS Inferentia 2</span><span class="tag">Stable Diffusion</span><span class="tag">Optimum Neuron</span><span class="tag">Hardware Acceleration</span><span class="tag">Cost-Effective Machine Learning</span>
</div>
<div class="links"><a class="link" href="../../../youtube.html">← Back to YouTube Overview</a></div>
</div>
</body>
</html>