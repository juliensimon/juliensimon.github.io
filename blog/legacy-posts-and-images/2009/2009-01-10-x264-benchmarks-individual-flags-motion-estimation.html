<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x264 benchmarks (individual flags & motion estimation)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        img {
            display: block;
            margin: 1.5rem auto;
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            clear: both;
        }
        
        /* Override any inline float styles on image links */
        a[style*="float"] {
            float: none !important;
            clear: both !important;
            display: block !important;
            text-align: center !important;
            margin: 1.5rem auto !important;
        }
        
        /* Center image containers */
        .separator {
            text-align: center !important;
            clear: both !important;
            margin: 1.5rem 0 !important;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', Monaco, monospace;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .date {
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 20px;
        }
        .content {
            margin-top: 30px;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>x264 benchmarks (individual flags & motion estimation)</h1>
    <div class="date">Published: 2009-01-10</div>
    <div class="content">
        <a href="#image-not-found">As discussed before</a>, finding the right set of <span style="font-style: italic;">x264</span> flags is a rather complex task. What do these flag mean? What's their effect on encoding time? On file size? On quality? All these are valid questions and the purpose of this article is to experiment and try to answer them.<br /><br />For this purpose, I will encode the same video with different flag combinations, measure encoding time and file size, and stream it on my PS3 using <a href="#image-not-found"><span style="font-style: italic;">mediatomb</span></a>. This is also a way to check that the PS3 supports the encoding flags I'm going to try.<br /><br /><span style="font-weight: bold;">1) A quick look at the test file</span><br /><br />I decided to pick a low resolution, high bitrate MPEG video. This way, artifacts will be much more visible when the video is displayed on a large screen, and it will also be interesting to see how much <span style="font-style: italic;">x264</span> can compress this any further.<br /><br />Here's what <a style="font-style: italic;" href="#image-not-found">mediainfo</a> reports:<br /><pre>ubuntu% <span style="font-weight: bold;">mediainfo video.mpg </span><br />General<br />Complete name                    : video.mpg<br />Format                           : MPEG-PS<br />File size                        : 41.8 MiB<br />Duration                         : 2mn 59s<br />Overall bit rate                 : 1 954 Kbps<br /><br />Video<br />ID                               : 224 (0xE0)<br />Format                           : MPEG Video<br />Format version                   : Version 1<br />Format settings, Matrix          : Default<br />Duration                         : 2mn 59s<br />Bit rate mode                    : Constant<br />Bit rate                         : 1 594 Kbps<br />Nominal bit rate                 : 1 700 Kbps<br />Width                            : 352 pixels<br />Height                           : 288 pixels<br />Display aspect ratio             : 4/3<br />Frame rate                       : 25.000 fps<br />Scan type                        : Progressive<br />Bits/(Pixel*Frame)               : 0.629<br /><br />Audio<br />ID                               : 192 (0xC0)<br />Format                           : MPEG Audio<br />Format version                   : Version 1<br />Format profile                   : Layer 2<br />Duration                         : 2mn 59s<br />Bit rate mode                    : Constant<br />Bit rate                         : 224 Kbps<br />Channel(s)                       : 2 channels<br />Sampling rate                    : 44.1 KHz<br />Resolution                       : 16 bits<br />Video delay                      : 280ms<br /></pre><span style="font-weight: bold;">2) Test "methodology"<br /><br /></span>Although I will also encode audio to AAC, I will only be benchmarking video: encoding times and file sizes discussed below are for the video stream only.<br /><br />Regarding video encoding, I've opted for Constant Rate Factor encoding (<span style="font-style: italic;">--crf</span> flag), with the same quality factor on all tests. Indeed, I'm not looking to achieve "the best encoding" (whatever that is): instead, I'm really trying to highlight the relative impact of a given flag on encoding.<br /><br />All tests are performed on Ubuntu 8.04, running on an 1.83GHz Intel Core 2 CPU (T5600 @ 1.83GHz). For the record, here are the actual commands, based on <a href="#image-not-found"><span style="font-style: italic;">ffmpeg</span></a> SVN-r16452 and <span style="font-style: italic;">MP4Box</span> 0.4.4:<br /><pre><br />% ffmpeg -i video.mpg -vn -acodec libfaac -aq 255 -ar 44100 -ac 2 -async 1 video.aac<br />% time ffmpeg -i video.mpg -f rawvideo - | x264 $X264_FLAGS -o video.264 - 352x288<br />% MP4Box -new -add video.aac -add video.264 video.mp4<br /></pre><span style="font-weight: bold;">3) Finding out the default values<br /><span style="font-weight: bold;"><br /></span></span>The first problem is to find out what default values x264 is using. It would not make a lot of sense to start tweaking if we don't know what the starting point it. Fortunately, mediainfo is able to dump encoding flags, so let's do a quick vanilla run (X264_FLAGS="<span style="font-style: italic;">--crf 21</span>"):<br /><code><br />ubuntu% <span style="font-weight: bold;">mediainfo video.mp4<br /></span></code><code><span style="font-style: italic;">output removed<br /></span></code><code>Format profile                   : <span style="font-weight: bold;">Main@L1.3<br /></span><span style="font-style: italic;">output removed</span><br />Encoding settings                : cabac=1 / <span style="font-weight: bold;">ref=1</span> / deblock=1:0:0 / <span style="font-weight: bold;">analyse=0x1:0x111</span> / <span style="font-weight: bold;">me=hex</span> / <span style="font-weight: bold;">subme=6</span> / psy_rd=1.0:0.0 / <span style="font-weight: bold;">mixed_ref=0</span> / me_range=16 / chroma_me=1 / trellis=0 / <span style="font-weight: bold;">8x8dct=0</span> / cqm=0 / deadzone=21,11 / chroma_qp_offset=-2 / threads=1 / nr=0 / decimate=1 / mbaff=0 / <span style="font-weight: bold;">bframes=0</span> / keyint=250 / keyint_min=25 / scenecut=40 / rc=crf / crf=21.0 / qcomp=0.60 / qpmin=10 / qpmax=51 / qpstep=4 / ip_ratio=1.40 / aq=1:1.00<br /></code><br />OK, so:<br /><ul><li>no B frames (<span style="font-style: italic;">bframes=0</span>)<br /><br /></li><li>only 1 reference frame (<span style="font-style: italic;">ref=1</span>), no mixed references (<span style="font-style: italic;">mixed_ref=0</span>)<br /><br /></li><li>partitions (<span style="font-style: italic;">analyse=0x111</span>): p8x8,b8x8,i8x8,i4x4<br /><br />Extracted from '<span style="font-style: italic;">x264.h</span>':<br /><code>/* Analyse flags<br />*/<br />#define X264_ANALYSE_I4x4       0x0001  /* Analyse i4x4 */<br />#define X264_ANALYSE_I8x8       0x0002  /* Analyse i8x8 (requires 8x8 transform) */<br />#define X264_ANALYSE_PSUB16x16  0x0010  /* Analyse p16x8, p8x16 and p8x8 */<br />#define X264_ANALYSE_PSUB8x8    0x0020  /* Analyse p8x4, p4x8, p4x4 */<br />#define X264_ANALYSE_BSUB16x16  0x0100  /* Analyse b16x8, b8x16 and b8x8 */</code><br /><br /></li><li>motion estimation method: hex (<span style="font-style: italic;">me=hex</span>)<br /><br />Extracted from '<span style="font-style: italic;">x264 --longhelp</span>':<br /><code><span style="font-weight: bold;">--me</span> <string>           Integer pixel motion estimation method<br />- dia: diamond search, radius 1 (fast)<br />- hex: hexagonal search, radius 2<br />- umh: uneven multi-hexagon search<br />- esa: exhaustive search<br />- tesa: hadamard exhaustive search (slow)<br /></string></code><br /></li><li>subpixel motion estimation method: 6 (<span style="font-style: italic;">subme=6</span>)<br /><br />Extracted from '<span style="font-style: italic;">x264 --longhelp</span>':<br /><code><span style="font-weight: bold;"></span> <span style="font-weight: bold;">--subme</span> <integer>       Subpixel motion estimation and mode decision<br />           - 0: fullpel only (not recommended)<br />           - 1: SAD mode decision, one qpel iteration<br />           - 2: SATD mode decision<br />           - 3-5: Progressively more qpel<br />           - 6: RD mode decision for I/P-frames<br />           - 7: RD mode decision for all frames<br />           - 8: RD refinement for I/P-frames<br />           - 9: RD refinement for all frames<br /><span style="font-family:Georgia,serif;"></span></integer></code></li></ul><span style="font-weight: bold;">4) Testing individual flags<br /><br /></span><span>These are the tests I'm going to run to try to find out what each additional flags costs and brings:<br /></span><ol><li><span style="font-style: italic;">--crf 21</span> : default values<br /><br /></li><li><span style="font-style: italic;">--crf 21 </span><span style="font-weight: bold; font-style: italic;">--bframes 16</span> : enable B frames (up to 16 consecutive frames)<br /><br /></li><li>-<span style="font-style: italic;">-crf 21 --bframes 16 </span><span style="font-weight: bold;"><span style="font-style: italic;">--b-pyramid</span> </span>: allow B frames to be referenced by other frames<br /><br /></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid </span><span style="font-weight: bold; font-style: italic;">--ref 8 --mixed-refs</span> : allow up to 8 frames to be referenced by P frames & allow references for partitions (instead of macroblocks)<br /><br /></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs </span><span style="font-weight: bold; font-style: italic;">--weightb</span> : allow weights to be set on referenced frames<br /><br /></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb </span><span style="font-weight: bold; font-style: italic;">--partitions all</span> : enable all partitions<br /><br /></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb --partitions all </span><span style="font-weight: bold; font-style: italic;">--8x8dct --direct-8x8 1</span> : enable 8x8 partitions in I frames<br /><br /></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb --partitions all --8x8dct --direct-8x8 1 </span><span style="font-weight: bold;"><span style="font-style: italic;">--no-fast-pskip</span></span><span style="font-style: italic;"> </span>: examine P frames more closely<span style="font-weight: bold;"><br /><br /></span></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb --partitions all --8x8dct --direct-8x8 1 --no-fast-pskip </span><span style="font-weight: bold;"><span style="font-style: italic;">--subme 7</span> </span>: work harder on subpixel motion estimation<span style="font-weight: bold;"><br /></span><span style="font-weight: bold;"><br /></span></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb --partitions all --8x8dct --direct-8x8 1 --no-fast-pskip --subme </span><span style="font-weight: bold;"><span style="font-style: italic;">8</span> </span>: work even harder on subpixel motion estimation<span style="font-weight: bold;"><br /></span><span style="font-weight: bold;"><br /></span></li><li><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb  --partitions all --8x8dct --direct-8x8 1 --direct auto --no-fast-pskip --subme </span><span style="font-weight: bold;"><span style="font-style: italic;">9</span> </span>: work extremely hard on subpixel motion estimation<span style="font-weight: bold;"> :)<br /></span></li></ol><span style="font-weight: bold;">5) Results on individual flags<br /><br /></span>Here are the results on the encoding time (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-07.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 400px; height: 264px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-07.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289617139439391298" border="0" /></a>Here are the results on the size of the output file (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-12.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 400px; height: 264px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-12.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289617146493313938" border="0" /></a>Here are the sequential variations, i.e. from one test case to the next (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-03.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 400px; height: 211px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-03.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289630842634979602" border="0" /></a><br /><span style="font-weight: bold;">6) Testing motion estimation</span><br /><br /><span>Here are the tests I'm going to run to compare different motion estimation methods, with both default and advanced subpixel motion estimation.<br /><br />All these tests also include '</span><span style="font-style: italic;">--crf 21 --bframes 16 --b-pyramid --ref 8 --mixed-refs --weightb --partitions all --8x8dct --direct-8x8 1 --no-fast-pskip</span>'.<span><br /></span><ol><li><span style="font-style: italic;">--me hex --subme 6</span> : hexagonal search, default subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me hex --subme 9</span> : hexagonal search, maximum subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me umh --subme 6</span> : uneven multi-hexagon search, default subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me umh --subme 9</span> : uneven multi-hexagon search, maximum subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me esa --subme 6</span> : exhaustive search, default subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me esa --subme 9</span> : exhaustive search, maximum subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me tesa --subme 6</span> : hadamard exhaustive search, default subpixel processing<br /><br /></li><li><span style="font-style: italic;">--me tesa --subme 9</span> : hadamard exhaustive search, maximum subpixel processing</li></ol><span style="font-weight: bold;">7) Results on motion estimation<br /><br /></span>Here are the results on the encoding time (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-05.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 389px; height: 380px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-05.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289619943748712562" border="0" /></a>Here are the results on the size of the output file (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-02.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 389px; height: 380px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-02.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289619944047922162" border="0" /></a>Here are the sequential variations, i.e. from one test case to the next (click for a larger version):<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-08.webp"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 400px; height: 200px;" src="2009-01-10-x264-benchmarks-individual-flags-motion-estimation-image-08.webp" alt="Technical performance metrics chart" id="BLOGGER_PHOTO_ID_5289631991082594690" border="0" /></a><span style="font-weight: bold;">8) Conclusion (?)</span><br /><br />Hmm, some really interesting figures in there: I need to think about it, so let's call it day for now :)<br /><br />I'll come back to these numbers very soon and I'll try to to explain / guess what they mean. All comments welcome, of course!
    </div>
</body>
</html>