<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Legacy blog post by Julien Simon">
  <meta name="author" content="Julien Simon">
  <meta name="robots" content="index, follow">
  
  <title>The Billion Dollar App Part3 â€“ Julien Simon</title>
  
  <!-- Umami Analytics -->
  <script>
    window.addEventListener('load', function() {
      var script = document.createElement('script');
      script.src = 'https://cloud.umami.is/script.js';
      script.setAttribute('data-website-id', '27550dad-d418-4f5d-ad1b-dab573da1020');
      document.head.appendChild(script);
    });
  </script>
  
  <!-- Resource hints for faster DNS resolution and connections -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
  
  <!-- Styles -->
  <link rel="stylesheet" href="../../css/styles.css">
  <link rel="stylesheet" href="../../css/social-icons.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
  
  <!-- Legacy post specific styles -->
  <style>
    .legacy-post-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-6);
      background: var(--background);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }
    
    .legacy-post-header {
      text-align: center;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 2px solid var(--border);
    }
    
    .legacy-post-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }
    
    .legacy-post-meta {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    
    .legacy-post-date {
      background: var(--surface);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
    }
    
    .legacy-post-category {
      background: var(--primary-color);
      color: white;
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
      text-transform: uppercase;
      font-size: var(--text-xs);
      letter-spacing: 0.5px;
    }
    
    .legacy-post-content {
      line-height: 1.8;
      color: var(--text-primary);
      font-size: var(--text-base);
    }
    
    .legacy-post-content h1,
    .legacy-post-content h2,
    .legacy-post-content h3,
    .legacy-post-content h4 {
      color: var(--text-primary);
      margin-top: var(--space-8);
      margin-bottom: var(--space-4);
      font-weight: 600;
    }
    
    .legacy-post-content h1 { font-size: var(--text-2xl); }
    .legacy-post-content h2 { font-size: var(--text-xl); }
    .legacy-post-content h3 { font-size: var(--text-lg); }
    .legacy-post-content h4 { font-size: var(--text-base); }
    
    .legacy-post-content p {
      margin-bottom: var(--space-4);
    }
    
    .legacy-post-content ul,
    .legacy-post-content ol {
      margin-bottom: var(--space-4);
      padding-left: var(--space-6);
    }
    
    .legacy-post-content li {
      margin-bottom: var(--space-2);
    }
    
    .legacy-post-content code {
      background: var(--surface);
      color: var(--primary-color);
      padding: var(--space-1) var(--space-2);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--text-sm);
    }
    
    .legacy-post-content pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: var(--space-4);
      overflow-x: auto;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content pre code {
      background: none;
      padding: 0;
      color: var(--text-primary);
    }
    
    .legacy-post-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: var(--space-4);
      margin: var(--space-6) 0;
      font-style: italic;
      color: var(--text-secondary);
    }
    
    .legacy-post-content a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    .legacy-post-content a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
    
    .legacy-post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .separator {
      clear: both;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .gist {
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content th,
    .legacy-post-content td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .legacy-post-content th {
      background: var(--surface);
      font-weight: 600;
    }
    
    .legacy-post-content strong,
    .legacy-post-content b {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .legacy-post-content em,
    .legacy-post-content i {
      font-style: italic;
    }
    
      background: var(--primary-color);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: var(--text-sm);
    }
    
    @media (max-width: 768px) {
      .legacy-post-container {
        padding: var(--space-4);
        margin: var(--space-4);
      }
      
      .legacy-post-title {
        font-size: var(--text-2xl);
      }
      
      .legacy-post-meta {
        flex-direction: column;
        gap: var(--space-2);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="../../assets/julien.webp" alt="Julien Simon" class="profile-image">
      <h1>Julien Simon</h1>
      <p class="title">Chief Evangelist @ Arcee AI</p>
      
    </header>

    <main>
      <article class="legacy-post-container">
        <header class="legacy-post-header">
          <h1 class="legacy-post-title">The Billion Dollar App Part3</h1>
          <div class="legacy-post-meta">
            <span class="legacy-post-date">August 3, 2013</span>
            <span class="legacy-post-category">Cloud & AWS</span>
          </div>
        </header>
        
        <div class="legacy-post-content">
          <p>In a <a href="2013-08-03-the-billion-dollar-app-part3.html">previous post</a>, we added caching to our Node.js&nbsp;+ MongoDB web application, thanks to an EC2 instance running <i>memcached</i>.</p>

<p>As you may know, AWS support its own brand of caching, aka ElastiCache: "<i>Amazon ElastiCache is protocol-compliant with Memcached, a widely adopted memory object caching system, so code, applications, and popular tools that you use today with existing Memcached environments will work seamlessly with the service</i>".</p>

<p>Seamlessly? Hmmm. Alright, let's take a look :)</p>

<p>First, let's use the AWS console to create an ElastiCache cluster. We'll start small, with 1 single micro node supporting a little over 200MB of cache. More than we need... and for free :)</p>

<p>Wait a couple of minutes and the cluster will come online. Let's check that the single node is accessible from our EC2 instance (no need to mess with the security group, port 11211 is open by default):</p>

<p><span>ubuntu@ip-10-48-249-35:~$ echo stats| <b>nc</b> memcache.9vficl.0001.euw1.cache.amazonaws.com 11211</span></p>

<p>This looks like <i>memcached</i> stats alright. Ok, now let's change a single line in our app, to use ElastiCache instead of our homemade&nbsp;instance:</p>

<p><span>// MemcacheClient = new mc.Client("10.234.177.74");</span></p>

<p><span>MemcacheClient = new mc.Client("memcache.9vficl.0001.euw1.cache.amazonaws.com");</span></p>

<p><div>
<div>
Now, let's run the app:</p>
        </div>
<div>
<span>ubuntu@ip-10-48-249-35:~$ <b>node</b> www4.js&nbsp;
<div>
<div>
<span>Web server started
<div>
<span>Connected to memcache
<div>
<span>Connected to database
</div>
<div>
<div>
Nice. Time for queries and console output!</div>
<div>
<div>
<span>Mac:~ julien$ <b>curl</b> http://ec2-54-216-3-139.eu-west-1.compute.amazonaws.com:8080/?id=51e3ce08915082db3df32bfc
</div>
<div>
<div>
<div>
<span>Request received, id=51e3ce08915082db3df32bfc
<div>
<span>Cache miss, key 51e3ce08915082db3df32bfc. Querying...
<div>
<span>Item found: {"_id":"51e3ce08915082db3df32bfc","x":13}
<div>
<span>Stored key=51e3ce08915082db3df32bfc, value=13
</div>


<div>
Let's replay the request quickly:</div>
<div>
<span>Request received, id=51e3ce08915082db3df32bfc
<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bfc, value=13</span>

<div>
And once more after 60 seconds (the item TTL):

<div>
<span>Request received, id=51e3ce08915082db3df32bfc
<div>
<span>Cache miss, key 51e3ce08915082db3df32bfc. Querying...
<div>
<span>Item found: {"_id":"51e3ce08915082db3df32bfc","x":13}
<div>
<span>Stored key=51e3ce08915082db3df32bfc, value=13
<div>
<div>
<div>
Let's stop the web app and look at the cache stats:</div>
<div>
<span>ubuntu@ip-10-48-249-35:~$ echo stats| <b>nc</b> memcache.9vficl.cfg.euw1.cache.amazonaws.com 11211|grep [g,s]et
<div>
<span>STAT cmd_get 3
<div>
<span>STAT cmd_set 2
<div>
<span>STAT cmd_config_get 134
<div>
<span>STAT cmd_config_set 1
<div>
<span>STAT get_hits 1
<div>
<span>STAT get_misses 2
</div>
<div>
God knows that 'seamlessly' is one of the most overused words in the IT business, but I've got to admit, this is truly seamless :)


As usual with AWS, you also get a bunch of graphs out of the box. That's a nice plus.




So that's the "cache" part of ElastiCache and it does what it's supposed to do. What about the 'elastic' part'?


Adding more nodes to the cluster is literally one click away: "Add node" :) After a few minutes, the new node is added to cluster.


Let's update our web app and relaunch it:

<span>// MemcacheClient = new mc.Client("10.234.177.74");</span>

<span>MemcacheClient = new mc.Client(["memcache.9vficl.0001.euw1.cache.amazonaws.com",&nbsp;</span><span>"memcache.9vficl.0002.euw1.cache.amazonaws.com"]</span><span>);</span>

<span>
ElastiCache has its own client, which allows the app to auto-discover new nodes without having to restart. Very nice, but the client is only available for Java (grumble) and PHP (bleh). Hopefully other languages are on the way.


Now, how about we hit the 2-node cluster with a little more traffic? This ugly script will do the trick:


<pre><code>#! /bin/sh
while (true)
do
        for i in {0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f}
        do
                j=51e3ce08915082db3df32bf$i
                curl ec2-176-34-161-199.eu-west-1.compute.amazonaws.com:8080/?id=$j >& /dev/null &
        done
sleep $1
done
</code></pre>



Let's run this in 2 or 3 local shells and wait for a little while. Coffee break :)


Alright, what do the graphs say?




One last thing to conclude: going back to the web app console output, we can clearly see the parallel asynchronous nature of Node.js at work.


<span>Stored key=51e3ce08915082db3df32bfd, value=14</span>

<span>Stored key=51e3ce08915082db3df32bff, value=16</span>

<span>Stored key=51e3ce08915082db3df32bfe, value=15</span>

<span>Request received, id=51e3ce08915082db3df32bf0</span>

<span>Request received, id=51e3ce08915082db3df32bf2</span>

<span>Request received, id=51e3ce08915082db3df32bf1</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bf0, value=1</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bf2, value=3</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bf1, value=2</span>

<span>Request received, id=51e3ce08915082db3df32bfb</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bfb, value=12</span>

<span><b>Request received, id=51e3ce08915082db3df32bfd

<span>Request received, id=51e3ce08915082db3df32bfc</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bfc, value=13</span>

<span>Request received, id=51e3ce08915082db3df32bf4</span>

<span>Request received, id=51e3ce08915082db3df32bf3</span>

<span>Cache hit, &nbsp;key=51e3ce08915082db3df32bf3, value=4</span>

<span>Request received, id=51e3ce08915082db3df32bf5</span>

<span><b>Cache hit, &nbsp;key=51e3ce08915082db3df32bfd, value=14


The two lines I've highlighted above come from the processing of the same HTTP request. However, a lot of stuff happened in the middle because other requests. Did I create threads? No. Did I mess with 'worker pools' or similar atrocities? No. I just wrote my code and let the framework do the rest.


That's it for today. Next time, we'll look at... ah, you'll see :)


Happy hacking.
        </div>
      </article>
    </main>

    <footer>
      <nav>
        <a href="../../index.html">Home</a>
        <a href="../../experience.html">Experience</a>
        <a href="../../publications.html">Publications</a>
        <a href="../../code.html">Code</a>
        <a href="../../books.html">Books</a>
        <a href="../../youtube.html">YouTube</a>
        <a href="../../computers.html">Computers</a>
        <a href="../../legacy-posts.html">Legacy Posts</a>
      </nav>
    </footer>
  </div>

  <script src="../../js/main.js"></script>
</body>
</html>