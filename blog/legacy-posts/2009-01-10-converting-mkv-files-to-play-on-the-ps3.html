<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Legacy blog post by Julien Simon">
  <meta name="author" content="Julien Simon">
  <meta name="robots" content="index, follow">
  
  <title>Converting Mkv Files To Play On The Ps3 â€“ Julien Simon</title>
  
  <!-- Umami Analytics -->
  <script>
    window.addEventListener('load', function() {
      var script = document.createElement('script');
      script.src = 'https://cloud.umami.is/script.js';
      script.setAttribute('data-website-id', '27550dad-d418-4f5d-ad1b-dab573da1020');
      document.head.appendChild(script);
    });
  </script>
  
  <!-- Resource hints for faster DNS resolution and connections -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
  
  <!-- Styles -->
  <link rel="stylesheet" href="../../css/styles.css">
  <link rel="stylesheet" href="../../css/social-icons.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
  
  <!-- Legacy post specific styles -->
  <style>
    .legacy-post-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-6);
      background: var(--background);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }
    
    .legacy-post-header {
      text-align: center;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 2px solid var(--border);
    }
    
    .legacy-post-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }
    
    .legacy-post-meta {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    
    .legacy-post-date {
      background: var(--surface);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
    }
    
    .legacy-post-category {
      background: var(--primary-color);
      color: white;
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
      text-transform: uppercase;
      font-size: var(--text-xs);
      letter-spacing: 0.5px;
    }
    
    .legacy-post-content {
      line-height: 1.8;
      color: var(--text-primary);
      font-size: var(--text-base);
    }
    
    .legacy-post-content h1,
    .legacy-post-content h2,
    .legacy-post-content h3,
    .legacy-post-content h4 {
      color: var(--text-primary);
      margin-top: var(--space-8);
      margin-bottom: var(--space-4);
      font-weight: 600;
    }
    
    .legacy-post-content h1 { font-size: var(--text-2xl); }
    .legacy-post-content h2 { font-size: var(--text-xl); }
    .legacy-post-content h3 { font-size: var(--text-lg); }
    .legacy-post-content h4 { font-size: var(--text-base); }
    
    .legacy-post-content p {
      margin-bottom: var(--space-4);
    }
    
    .legacy-post-content ul,
    .legacy-post-content ol {
      margin-bottom: var(--space-4);
      padding-left: var(--space-6);
    }
    
    .legacy-post-content li {
      margin-bottom: var(--space-2);
    }
    
    .legacy-post-content code {
      background: var(--surface);
      color: var(--primary-color);
      padding: var(--space-1) var(--space-2);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--text-sm);
    }
    
    .legacy-post-content pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: var(--space-4);
      overflow-x: auto;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content pre code {
      background: none;
      padding: 0;
      color: var(--text-primary);
    }
    
    .legacy-post-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: var(--space-4);
      margin: var(--space-6) 0;
      font-style: italic;
      color: var(--text-secondary);
    }
    
    .legacy-post-content a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    .legacy-post-content a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
    
    .legacy-post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .separator {
      clear: both;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .gist {
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content th,
    .legacy-post-content td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .legacy-post-content th {
      background: var(--surface);
      font-weight: 600;
    }
    
    .legacy-post-content strong,
    .legacy-post-content b {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .legacy-post-content em,
    .legacy-post-content i {
      font-style: italic;
    }
    
      background: var(--primary-color);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: var(--text-sm);
    }
    
    @media (max-width: 768px) {
      .legacy-post-container {
        padding: var(--space-4);
        margin: var(--space-4);
      }
      
      .legacy-post-title {
        font-size: var(--text-2xl);
      }
      
      .legacy-post-meta {
        flex-direction: column;
        gap: var(--space-2);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="../../assets/julien.webp" alt="Julien Simon" class="profile-image">
      <h1>Julien Simon</h1>
      <p class="title">Chief Evangelist @ Arcee AI</p>
      
    </header>

    <main>
      <article class="legacy-post-container">
        <header class="legacy-post-header">
          <h1 class="legacy-post-title">Converting Mkv Files To Play On The Ps3</h1>
          <div class="legacy-post-meta">
            <span class="legacy-post-date">January 10, 2009</span>
            <span class="legacy-post-category">Linux & Ubuntu</span>
          </div>
        </header>
        
        <div class="legacy-post-content">
          <p>There's no doubt that <a href="http://www.matroska.org/">Matroska</a> is a great open source container that can store anything (and the kitchen sink too). Unfortunately, as of today, it's not well supported by consumer devices. So, unless you decide to use your computer for viewing, you need to convert <span>mkv</span> files into something that your device can play.</p>

<p>The purpose of this article is to show how to do that for the PS3. It may very well work on other devices, but don't blame if it doesn't :)</p>

<p>This article is a work in progress. Are covered so far:
<ul><li><span>Example #1: (mkv file, H.264, AC3) --> (MPEG-2 TS file, H.264, AC3)<li><span>Example #2: (mkv file, H.264, AC3) --> (MPEG-2 PS file, H.264, AC3)<li><span>Example #3: (mkv file, H.264, AC3) --> (MP4 file, H.264, AAC)
</li><li><span>Example #4: (mkv file, H.264 level 5.1, DTS 5.1) --> (</span><span>MP4</span><span> file, H.264 level 4.1, AAC)
</li><li><span>Example #5: </span><span>(mkv file, MPEG-2 video, DTS 5.1 + AC3) --> (</span><span>MPEG-2 PS</span><span> file, </span><span>MPEG-2 video,</span><span> AC3)<li><span>Example #6: (mkv file, MPEG-2 video, DTS 5.1 + AC3) --> (MPEG-2 PS file, </span><span>MPEG-2 video,</span><span> AC3 5.1)<li><span>Example #7: (mkv file, MPEG-2 video, DTS 5.1 + AC3) --> (MP4 file, H.264 video, AAC)<span>1) Pre-requisites</span></p>

<p>Before we start, let's prepare our toolbox:
<ul><li><span>mediainfo</span> : the best tool to learn everything there is know on the true nature of your media files. I showed you how to build it <a href="2009-01-04-compiling-mediainfo-cli-gui-on-ubuntu.html">in a previous article</a>.
<li><span>mkvtoolnix</span> : a collection of tools to inspect, extract and build mkv files.
<code>
ubuntu% <span>sudo apt-get install mkvtoolnix</span><li><span>ffmpeg</span> : the best general-purpose audio &amp; video transcoding tool. I also showed you how to build it <a href="2008-20-12-compiling-ffmeg-x264-mp3-xvid-amr-on-ubuntu.html">in a previous article</a>.
<li><span>MP4Box</span> : a nice MP4 manipulation tool, which we'll use for multiplexing.</p>

<p><code>ubuntu% <span>sudo apt-get install gpac
<li><span>tsMuxer</span> : another great tool for multiplexing. You can download a pre-compiled version <a href="http://www.smlabs.net/tsmuxer_en.html">here</a>. Just copy the <span>tsMuxer</span> binary in <span>/usr/local/bin</span>.<span>2) Audio &amp; video formats supported by the PS3
Let's take at a look at what the PS3 actually supports, That way, we will avoid any unnecessary transcoding. Remember that the content we're dealing has already been compressed, so any additional processing would certainly degrade quality. Also, video encoding takes a LOT of time, especially with HD files...</p>

<p>According to the <a href="http://manuals.playstation.net/document/en/ps3/current/video/filetypes.html">online manual</a>, the PS3 supports:
<ul><li>MPEG-1 video, with MPEG-1 layer 2 audio
<li>MP4 container : H.264/MPEG-4 AVC High Profile video, with AAC LC audio
<li>MPEG-2 PS container (aka VOB file): MPEG-2 video, with either one of these audio formats : MPEG-2 Audio Layer 2, AAC LC, AC3 (Dolby Digital), LPCM audio
<li>MPEG-2 TS container :<ul><li>MPEG-2 video, with either one of these audio formats : MPEG-2 Audio Layer 2, AAC LC, AC3 (Dolby Digital)<li>H.264/MPEG-4 AVC video, with AAC LC audio<ul><li>AVCHD, AVI, DivX and VC-1 (WMV), which are less likely to be encountered in <span>mkv</span> files.So what does this mean? Well, here are a few rules:
<ul><li>Obviously, the PS3 does not support the <span>mkv</span> container. Any input file in this format must be at least remuxed.
<li>The PS3 does support DTS audio, but only when played from actual disks, i.e. not from files. Thus, any input stream in this format must be transcoded.
<li>MP3 audio, Vorbis audio and so on are not supported and must be transcoded.
<li>If you want AC3 audio, you must use a MPEG-2 TS/PS container.
<li>If you want to stick with the MP4 container, you really have no options but H.264 video and AAC audio.</ul><span>3) Getting things done
Now that we know what is supported and what isn't, we can pick the right solution, i.e. preserve the quality of the input file and save time.</p>

<p>The approach will always be the same:
<ul><li>inspect the <span>mkv</span> file and identify the nature of its streams,
<li>extract the video stream and the audio stream (possibly among several available ones)
<li>depending on what your audio setup supports, select a format for the audio output (AC3 will do you no good if you don't have a Dolby Digital setup)
<li>based on the previous item and on what the PS3 supports, transcode the audio and/or video stream
<li>remux the audio and the video stream into a container supported by the PS3
<li>play the file :)Let's look at real-life examples and sort them out!</p>

<p><span>4) Example #1: (mkv file, H.264, AC3) --> (MPEG-2 TS file, H.264, AC3)
Let's look at our input file with <span>mediainfo</span> (edited for brevity):
<code>
ubuntu% <span>mediainfo video.mkv</span>
General
Complete name                    : video.mkv
Format                           : Matroska
File size                        : 1.09 GiB
Duration                         : 41mn 48s
Overall bit rate                 : 3 740 Kbps</p>

<p>Video
Format                           : AVC
Format/Info                      : Advanced Video Codec
Format profile                   : High@L3.1
Codec ID                         : V_MPEG4/ISO/AVC
Width                            : 1 280 pixels
Height                           : 720 pixels
Frame rate                       : 23.976 fps</p>

<p>Audio
Format                           : AC-3
Format/Info                      : Audio Coding 3
Codec ID                         : A_AC3
Channel(s)                       : 6 channels
Channel positions                : Front: L C R, Surround: L R, LFE
You can also use <span>mkvinfo</span> (part of the <span>mkvtoolnix</span> package):
<code>
ubuntu% <span>mkvinfo</span><span> video.mkv </span>
|  + Track number: 1
|  + Track type: video
|  + Codec ID: V_MPEG4/ISO/AVC
|  + Video track
|   + Pixel width: 1280
|   + Pixel height: 720</p>

<p>|  + Track number: 2
|  + Track type: audio
|  + Codec ID: A_AC3
So what is this file? It's a 2-track <span>mkv</span> file: track 1 is H.264 video (1280x720), track 2 is AC3 6-channel audio. Both formats are supported by the PS3, and since they're high quality it would be a shame to transcode them. Let's try a simple remuxing into... no, not MP4 because it doesn't support AC3: we have to use MPEG-2 TS.</p>

<p>This is where <span>tsMuxer</span> comes in. The good thing about it is that we don't have to extract the individual streams, this will be handled for us.</p>

<p>Although <span>tsMuxer </span><span>is</span> a command-line tool, it can only read its parameters from a file (let's call it <span>tsmuxer.meta</span>):
<pre>MUXOPT --no-pcr-on-video-pid --new-audio-pes --vbr
V_MPEG4/ISO/AVC, video.mkv, level=4.1, insertSEI, contSPS, track=1, lang=eng
A_AC3, video.mkv, track=2, lang=engIgnore the first line and look at the next two. On each of them, we're describing a stream and telling <span>tsMuxer</span> what format it is and where to find it (file name and track number). Don't worry, this information is dumped by <span>mediainfo</span> or <span>mkvinfo</span> (go back and check), so you shouldn't have any problem writing the file :)</p>

<p>Now, we're ready to remux:
<code>
ubuntu% <span>tsMuxeR tsmuxer.meta video.m2ts<span>output removed</span><span>
Mux successful complete.
Muxing time: 5 min 25 sec</code>
That's all: this file plays fine on the PS3 (I'm streaming it right now using <a href="2008-12-24-mediatomb-0-12-on-ps3-video-thumbnails-youtube-apple-movie-trailers.html"><span>mediatomb). Total time: about 10 minutes. And we preserved the original quality of the input file.</p>

<p><span>5) Example #2: (mkv file, H.264, AC3) --> (MPEG-2 PS file, H.264, AC3)
Here, we'll use the same input file as example #1, but we'll remux it to MPEG2-PS (aka the VOB format). This is also interesting if you want to do without <span>tsMuxer</span>.<span>
Wouldn't it be nice to be able to just do this?</p>

<p><code>ubuntu% <span>ffmpeg -i video.mkv -acodec copy -vcodec copy -r 23.976 -f vob video.mpg<span>[NULL @ 0x8076d00]error, non monotone timestamps 15030 >= 7470
av_interleaved_write_frame(): Error while opening file</p>

<p>As you can see, it doesn't work. Not sure why... Let's use a two-step solution instead. First, let's extract the streams from the <span>mkv</span> file:</p>

<p><code>ubuntu% <span>mkvextract tracks video.mkv 1:video.h264 2:audio.ac3</code>
Now, let's remux the streams into a MPEG2-PS container:</p>

<p><code>ubuntu%</span><span> ffmpeg -i video.h264 -i audio.ac3 -map 0.0:0 -map 1.0:0 -acodec copy -vcodec copy -r 23.976 -f vob video.mpg<span>
That's it. This solution is a little bit longer than the previous one, but it works and doesn't require you to write the <span>tsMuxer</span> meta file :)<span>
<span>6) Example #3: (mkv file, H.264, AC3) --> (MP4 file, H.264, AAC)
Here, we'll also use the same input file as example #1. For whatever reason, we need to use the MP4 container (maybe to be able to play that file on another device). This means that we must also drop AC3 in favor of AAC.</p>

<p>We have already inspected the file, so let's extract the streams:</p>

<p><code>ubuntu% <span>mkvextract tracks video.mkv 1:video.h264 2:audio.ac3</p>

<p>Then, we need to transcode the audio stream to AAC (let's use high-quality VBR):
<code>
ubuntu% <span>ffmpeg -i audio.ac3 -acodec libfaac -aq 255 -ar 44100 -ac 2 -async 1 -vsync 1 audio.aac </span>
Now, we'll use <span>MP4Box</span> to remux the initial video stream and the new audio stream into an MP4 container:
<code>
ubuntu% <span>MP4Box -new -add audio.aac -add video.h264 -fps 23.976 video.mp4<span>AAC import - sample rate 44100 - MPEG-4 audio - 2 channels
AVC-H264 import - frame size 1280 x 720 at 23.976 FPS
Import results: 60146 samples - Slices: 1027 I 36894 P 22225 B - 1 SEI - 968 IDR
Stream uses B-slice references - max frame delay 2
Saving video-ps3.mp4: 0.500 secs Interleaving</span><span></code>
That's it :)</p>

<p><span>7) Example #4: (mkv file, H.264 level 5.1, DTS 5.1) --> (MP4 file, H.264 level 4.1, AAC)
Here, we'll use a new sample file (for the sake of brevity, I will just display the relevant lines):
<pre>ubuntu% <span>mediainfo video2.mkv</span>
General
Complete name                    : video2.mkv
Format                           : Matroska</p>

<p>Video
Format                           : AVC
Format/Info                      : Advanced Video Codec
Format profile                   : High@L5.1
Muxing mode                      : Container profile=Unknown@5.1
Codec ID                         : V_MPEG4/ISO/AVC
Frame rate                       : 23.976 fps</p>

<p>Audio
Format                           : DTS
Format/Info                      : Digital Theater Systems
Codec ID                         : A_DTS</p>

<p>ubuntu% <span>mkvinfo video2.mkv</span></p>

<p>| + A track
|  + Track number: 1
|  + Track type: video
|  + Codec ID: V_MPEG4/ISO/AVC</p>

<p>| + A track
|  + Track number: 2
|  + Track type: audio
|  + Codec ID: A_DTSOK, so track 1 is H.264 video and track 2 is DTS audio. Let's extract them:</p>

<p><code>ubuntu% <span>mkvextract tracks video2.mkv 1:video.h264 2:audio.dts
</code>According to what I've said earlier, H.264 is supported, so all we have to do is to transcode the audio... right?</p>

<p>Wrong :) Take another look at the video stream: format profile is "<span>High @ Level 5.1</span>" (note: this has nothing to do with 5.1 audio!). Unfortunately, the PS3 cannot play anything above Level 4.1, so this video stream needs to be fixed. Does this mean we have to reencode it and lose quality?</p>

<p>Nope :) We're going to change the level right in the binary file. For this purpose, you need an hexadecimal editor. I recommend <span>ghex2</span>, which can easily be installed with '<span>sudo apt-get install ghex</span>'.</p>

<p>just go '<span>ghex2 video.h264</span>' and look at the first 8 bytes of the file: they should read '<span>00 00 00 01 67 64 00 33</span>'. Hmm... <span>0x33</span> in decimal is '<span>51</span>', which means 'level 5.1' : let's change this byte to <span>0x29</span> ('<span>41</span>' in decimal) to 'downgrade' the video to level 4.1 and save the file.</p>

<p>Now, let's take care of the audio stream. As above, we'll use high quality VBR:
<code>
ubuntu% <span>ffmpeg -i audio.dts -acodec libfaac -aq 255 -ar 44100 -ac 2 -async 1 -vsync 1 audio.aac </span>
The last operation is to remux the initial video stream and the new audio stream into an MP4 container:
<code>
ubuntu% <span>MP4Box -new -add audio.aac -add video.x264 -fps 23.976 video.mp4<span></code>That's it. I'm not sure the level hack will always work, but it did in this case and we avoided any video transcoding.</p>

<p><span>8) Example #5: (mkv file, MPEG-2 video, DTS 5.1+ AC3) --> (MPEG-2 PS file, </span><span>MPEG-2 video,</span><span> AC3)
Let's take a look at this one (output edited for brevity)
<pre>ubuntu% <span>mediainfo video3.mkv </span>
General
Complete name                    : video3.mkv
Format                           : Matroska
File size                        : 73.9 MiB
Duration                         : 50s 240ms
Overall bit rate                 : 12.3 Mbps</p>

<p>Video
Format                           : MPEG Video
Format version                   : Version 2
Format profile                   : Main@High
Format settings, Matrix          : Default
Codec ID                         : V_MPEG2
Width                            : 1 920 pixels
Height                           : 1 080 pixels</p>

<p>Audio #1
Format                           : DTS
Format/Info                      : Digital Theater Systems
Codec ID                         : A_DTS
Language                         : Russian</p>

<p>Audio #2
Format                           : AC-3
Format/Info                      : Audio Coding 3
Codec ID                         : A_AC3
Language                         : English</p>

<p>ubuntu% <span>mkvinfo video3.mkv </span>
|  + Track number: 1
|  + Track type: video
|  + Codec ID: V_MPEG2</p>

<p>|  + Track number: 2
|  + Track type: audio
|  + Codec ID: A_DTS</p>

<p>|  + Track number: 3
|  + Track type: audio
|  + Codec ID: A_AC3Track #1 is full HD MPEG-2 video, track #2 is DTS audio in Russian and track #3 is AC3 audio in English. Let's extract them:</p>

<p><code>ubuntu% <span>mkvextract tracks video3.mkv 1:video.mpeg 2:audio.dts 3:audio.ac3</p>

<p>If like me you don't speak Russian, you'll pick track #3 :) If you do speak Russian, please refer to the next example for DTS-->AC3 conversion.</p>

<p>One option would be to remux tracks #1 and #3 into an MPEG-2 TS container (like we did in example #1). Unfortunately, <span>tsMuxer</span> chokes on the video stream ('<span>Can't detect stream type</span>').</p>

<p>Let's try to remux in an MPEG-2 PS container. For this, we'll use <span>ffmpeg</span> but without any transcoding:</p>

<p><code>ubuntu%<span> ffmpeg -i video.mpeg -i audio.ac3 -map 0.0:0 -map 1.0:0 -acodec copy -vcodec copy -f vob video.mpg
</code>That's it!</p>

<p><span>9) Example #6: (mkv file, MPEG-2 video, DTS 5.1 + AC3) --> (MPEG-2 PS file, </span><span>MPEG-2 video,</span><span> AC3 5.1)
We'll use the same input file as in example #5, but this time we'll use convert the DTS audio stream and convert it to AC3.</p>

<p>Let's take another look at the DTS stream:
<code>
ubuntu% <span>mediainfo audio.dts </span>
General
Complete name                    : audio.dts
Format                           : DTS
Format/Info                      : Digital Theater Systems
File size                        : 9.04 MiB
Duration                         : 49s 381ms
Overall bit rate                 : 1 536 Kbps</p>

<p>Audio
Format                           : DTS
Format/Info                      : Digital Theater Systems
Bit rate mode                    : Constant
Bit rate                         : 1 536 Kbps
Channel(s)                       : 6 channels
Channel positions                : Front: L C R, Surround: L R, LFE
Sampling rate                    : 48.0 KHz
Resolution                       : 16 bits
Since the DTS stream has 6 channels, we can either transcode it to 2-channel AC3 or 6-channel AC3. Let me show you both:
<code>
ubuntu% <span>ffmpeg -i audio.dts -acodec ac3 -ar 48000 -ab 448k -ac 2 audio-2ch.ac3
<code>
ubuntu% <span>ffmpeg -i audio.dts -acodec ac3 -ar 48000 -ab 448k -ac 6 audio-6ch.ac3</p>

<p>448 KBit/s is the maximum authorized AC3 bitrate for DVDs. However, with the Playstation 3, we could go up to 640Kbit/s.</p>

<p>Now, let's remux the video and audio streams (I'll use 6-channel AC3 here):</p>

<p><code>ubuntu%<span> ffmpeg -i video.mpeg -i audio-6ch.ac3 -map 0.0:0 -map 1.0:0 -acodec copy -vcodec copy -f vob video.mpg
</code>That's it.</p>

<p>1<span>0) Example #7: (mkv file, MPEG-2 video, DTS 5.1 + AC3) --> (MP4 file, H.264 video, AAC)</span></p>

<p>We'll use the same input file as in example #5. Let's assume that - like in example #3 - we need to use the MP4 container. This means that we must convert the video stream to H.264 and our preferred audio stream (AC3 for this purpose) to AAC.</p>

<p>Please note that this is not the best option! The video compression will be lossy and all the longer that we're dealing with a 1920x1080 video stream. As far as audio is concerning, we're moving from 6-channel AC3 to stereo AAC. So, unless you <span>really</span> need the MP4 container, I strongly suggest that you use the solution described in example #6.</p>

<p>Anyway, let's get started and extract the MPEG-2 and AC3 streams:
<code>
ubuntu% <span>mkvextract tracks video3.mkv 1:video.mpeg 3:audio.ac3</span>
Then, let's encode the audio stream to AAC:
<code>
ubuntu% <span>ffmpeg -i audio.ac3 -acodec libfaac -aq 255 -ar 44100 -ac 2 -async 1 -vsync 1 audio.aac</span>
Now, the big one: encoding the MPEG-2 stream to H.264:
<code>
ubuntu% <span>ffmpeg -i video.mpeg -f rawvideo - | x264  --level 4.1 --crf 21 --bframes 16 --b-pyramid --ref 4 --mixed-refs --weightb --partitions all --threads 2 -o video.h264 - 1920x1080</span>
Let's explain this line a bit: as you can see, we're using <span>ffmpeg</span> to decode the video stream to raw video and we're piping the output into the <span>x264</span> encoder. The reason for this is avoid any H.264 default value that could be set by <span>ffmpeg</span>: indeed, piping guarantees that all H.264 flags will be set by <span>x264</span>.</p>

<p>What about the <span>x264</span> flags? '<span>--level 4.1</span>' sets the H.264 level (the PS3 can't play anything above 4.1, please see example #4 for more information). '<span>--crf 21</span>' select Constant Rate Factor encoding, with default quality. '<span>--bframes 16 --b-pyramid --ref 4 --mixed-refs --weightb --partitions all</span>' are frame options which seem to strike the right balance between quality and encoding time (please see <a href="2009-01-07-ffmpeg-x264-presets.html">this article</a> for more information). Finally, '<span>--threads 2</span>' will create 2 encoding threads.</p>

<p>FYI, on a dual-core PC @ 1.83 GHz, this command took 8 minutes to encode a 50-second video! Now you understand why you don't want to do this unless you have no other option.</p>

<p>Now, the final step: remuxing into an MP4 container
<code>
ubuntu% <span>MP4Box -new -add video.h264 -add audio.aac -fps 25 video.mp4</span>
That's it!</p>

<p><span>11) What's next
These examples should get you started. I will be adding tips and tricks as I am faced with increasingly hostile <span>mkv</span> files ;) In the meantime, have fun and as always, all comments welcome.</p>

<p><span>Updated 2009/01/16: </span><a href="2009-01-16-processing-multichannel-audio-dts-ac3-wav.html">this post</a><span> has more advanced information on DTS to AC3 conversion.</span></p>
        </div>
      </article>
    </main>

    <footer>
      <nav>
        <a href="../../index.html">Home</a>
        <a href="../../experience.html">Experience</a>
        <a href="../../publications.html">Publications</a>
        <a href="../../code.html">Code</a>
        <a href="../../books.html">Books</a>
        <a href="../../youtube.html">YouTube</a>
        <a href="../../computers.html">Computers</a>
        <a href="../../legacy-posts.html">Legacy Posts</a>
      </nav>
    </footer>
  </div>

  <script src="../../js/main.js"></script>
</body>
</html>