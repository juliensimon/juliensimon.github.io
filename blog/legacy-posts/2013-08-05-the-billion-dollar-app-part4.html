<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Legacy blog post by Julien Simon">
  <meta name="author" content="Julien Simon">
  <meta name="robots" content="index, follow">
  
  <title>The Billion Dollar App Part4 â€“ Julien Simon</title>
  
  <!-- Umami Analytics -->
  <script>
    window.addEventListener('load', function() {
      var script = document.createElement('script');
      script.src = 'https://cloud.umami.is/script.js';
      script.setAttribute('data-website-id', '27550dad-d418-4f5d-ad1b-dab573da1020');
      document.head.appendChild(script);
    });
  </script>
  
  <!-- Resource hints for faster DNS resolution and connections -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
  
  <!-- Styles -->
  <link rel="stylesheet" href="../../css/styles.css">
  <link rel="stylesheet" href="../../css/social-icons.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
  
  <!-- Legacy post specific styles -->
  <style>
    .legacy-post-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-6);
      background: var(--background);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }
    
    .legacy-post-header {
      text-align: center;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 2px solid var(--border);
    }
    
    .legacy-post-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }
    
    .legacy-post-meta {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    
    .legacy-post-date {
      background: var(--surface);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
    }
    
    .legacy-post-category {
      background: var(--primary-color);
      color: white;
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-weight: 500;
      text-transform: uppercase;
      font-size: var(--text-xs);
      letter-spacing: 0.5px;
    }
    
    .legacy-post-content {
      line-height: 1.8;
      color: var(--text-primary);
      font-size: var(--text-base);
    }
    
    .legacy-post-content h1,
    .legacy-post-content h2,
    .legacy-post-content h3,
    .legacy-post-content h4 {
      color: var(--text-primary);
      margin-top: var(--space-8);
      margin-bottom: var(--space-4);
      font-weight: 600;
    }
    
    .legacy-post-content h1 { font-size: var(--text-2xl); }
    .legacy-post-content h2 { font-size: var(--text-xl); }
    .legacy-post-content h3 { font-size: var(--text-lg); }
    .legacy-post-content h4 { font-size: var(--text-base); }
    
    .legacy-post-content p {
      margin-bottom: var(--space-4);
    }
    
    .legacy-post-content ul,
    .legacy-post-content ol {
      margin-bottom: var(--space-4);
      padding-left: var(--space-6);
    }
    
    .legacy-post-content li {
      margin-bottom: var(--space-2);
    }
    
    .legacy-post-content code {
      background: var(--surface);
      color: var(--primary-color);
      padding: var(--space-1) var(--space-2);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--text-sm);
    }
    
    .legacy-post-content pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: var(--space-4);
      overflow-x: auto;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content pre code {
      background: none;
      padding: 0;
      color: var(--text-primary);
    }
    
    .legacy-post-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: var(--space-4);
      margin: var(--space-6) 0;
      font-style: italic;
      color: var(--text-secondary);
    }
    
    .legacy-post-content a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    .legacy-post-content a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
    
    .legacy-post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .separator {
      clear: both;
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content .gist {
      margin: var(--space-4) 0;
    }
    
    .legacy-post-content table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-6) 0;
    }
    
    .legacy-post-content th,
    .legacy-post-content td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .legacy-post-content th {
      background: var(--surface);
      font-weight: 600;
    }
    
    .legacy-post-content strong,
    .legacy-post-content b {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .legacy-post-content em,
    .legacy-post-content i {
      font-style: italic;
    }
    
      background: var(--primary-color);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: var(--text-sm);
    }
    
    @media (max-width: 768px) {
      .legacy-post-container {
        padding: var(--space-4);
        margin: var(--space-4);
      }
      
      .legacy-post-title {
        font-size: var(--text-2xl);
      }
      
      .legacy-post-meta {
        flex-direction: column;
        gap: var(--space-2);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="../../assets/julien.webp" alt="Julien Simon" class="profile-image">
      <h1>Julien Simon</h1>
      <p class="title">Chief Evangelist @ Arcee AI</p>
      
    </header>

    <main>
      <article class="legacy-post-container">
        <header class="legacy-post-header">
          <h1 class="legacy-post-title">The Billion Dollar App Part4</h1>
          <div class="legacy-post-meta">
            <span class="legacy-post-date">August 5, 2013</span>
            <span class="legacy-post-category">Cloud & AWS</span>
          </div>
        </header>
        
        <div class="legacy-post-content">
          <p>To paraphrase the immortal Samuel Jackson in Pulp Fiction: "<em>Logs! The cornerstone of any nutritious application!</em>". And <a href="2013-08-05-the-billion-dollar-app-part4.html">my Node.js app</a> doesn't have any! As Mr Brando once said "<em>Ah, the horror, the horror!</em>". At the time, he probably didn't worry about log management, but the quote is definitely relevant for that too :D</p>

          <p>I'm an old fashioned guy, so the first thing that comes to my mind is : "<em>syslog</em>". We could certainly find fancier ways (yes, I'm looking at you, scala-*), but <em>syslog</em> will do for now.</p>

          <p>Once again, I'll use an Ubuntu 12.04 instance in EC2, which happens to have a running <em>rsyslogd</em> :) Let's take a look at the main config file, <em>/etc/rsyslogd.conf.</em></p>

          <p>We'll use UDP to ship our logs. However, because of this <a href="https://bugs.launchpad.net/ubuntu/+source/rsyslog/+bug/789174">unbelievable 2-year old bug</a>, we can't use port 514 (the default port for <em>syslog</em>): we'll use 5140 instead, don't forget to open 5140/UDP in the security group of the EC2 instance!</p>

          <pre><code># provides UDP syslog reception
$ModLoad imudp
$UDPServerRun 5140</code></pre>

          <p>Let's now look at the default rules, located in <em>/etc/rsyslog.d/50-default.conf</em>. Let's keep it very simple and make sure we log everything. We'll also add a new template, because the default one misses some useful information, such as priority (duh!).</p>

          <pre><code>$template TraditionalFormatWithPRI,"%pri-text%: %timegenerated% %HOSTNAME% %syslogtag%%msg:::drop-last-lf%\n"
*.*    /var/log/messages;TraditionalFormatWithPRI</code></pre>

          <p>I hear my sysadmin team booing the ugliness of this setup. Yeah, I love you too, bitchez :-P</p>

          <p>Anyway, this should be enough, now we just need to restart <em>rsyslogd</em>:</p>

          <pre><code>ubuntu@ip-10-34-245-176:~$ sudo <strong>service</strong> rsyslog restart

rsyslog stop/waiting
rsyslog start/running, process 4639</code></pre>

          <p>Now, let's move back to our Node.js instance and try to talk to our syslog server:</p>

          <pre><code>ubuntu@ip-10-37-166-19:~$ <strong>echo</strong> "<14>Node sez: I see you"|<strong>nc</strong> -u -v -w0 10.34.245.176 5140</code></pre>

          <p>If you tail <code>/var/log/messages</code> on the syslog server, the last line should say:</p>

          <pre><code>user.info<14>: Aug  5 14:40:18 Node sez: I see you</code></pre>

          <p>OK. Now that we have a running syslog server, how is the Node.js app going to send it data? The good news is that there's a large number of packages to do this. The bad news is, most of them don't seem to work very well...</p>

          <p><a href="https://npmjs.org/package/ain2">Ain2</a> worked right out of the box. If you're only looking for a syslog module, I would recommend this one. However, I ended up picking <a href="https://github.com/flatiron/winston"><em>winston</em></a>, an interesting logging framework supporting many different transports (file, http, several databases, etc) including syslog through the <a href="https://github.com/indexzero/winston-syslog"><em>winston-syslog</em></a> module.</p>

          <p>In theory, at least. For the life of me, I couldn't get this thing to work, despite a lot of creative hacking and creative swearing too. Fortunately, <a href="https://github.com/sanpan/winston-syslogUdp"><em>winston-syslogUdp</em></a> works: "<em>It was created when the authors experienced challenges with winston-syslog</em>". Yeah, tell me about it! Good job, guys.</p>

          <p><em>winston</em> requires a newer version of Node.js than the one available in the Ubuntu repo, so let's take care of this upgrade first:</p>

          <pre><code>ubuntu@ip-10-37-166-19:~$ sudo <strong>add-apt-repository</strong> ppa:chris-lea/node.js

ubuntu@ip-10-37-166-19:~$ sudo <strong>apt-get</strong> update

ubuntu@ip-10-37-166-19:~$ sudo <strong>apt-cache</strong> show nodejs|<strong>grep</strong> Version
Version: 0.10.15-1chl1~precise1
Version: 0.6.12~dfsg1-1ubuntu1

ubuntu@ip-10-37-166-19:~$ sudo <strong>apt-get</strong> install nodejs=0.10.15-1chl1~precise1

ubuntu@ip-10-37-166-19:~$ <strong>node</strong> -v
v0.10.15</code></pre>

          <p>Now, let's update the Node.js packages and install the winston packages:</p>

          <pre><code>ubuntu@ip-10-37-166-19:~$ <strong>npm</strong> update

ubuntu@ip-10-37-166-19:~$ <strong>npm</strong> install winston winston-syslogudp</code></pre>

          <p>After some more hacking and swearing (but no drinking, I promise), I adapted my program to use <em>winston</em>, with the following setup:</p>

          <ul>
            <li>don't log to the console</li>
            <li>log to a local file</li>
            <li>log to a remote syslog server</li>
          </ul>

          <p>Here how you do this, it's really simple:</p>

          <pre><code>// Don't log to console
winston.remove(winston.transports.Console);

// Log to local file
winston.add(winston.transports.File, { filename: 'log.txt' });

// Log to remote syslog
winston.add(winston.transports.Syslog, {"host":"10.34.245.176", "port":"5140", "localhost":"10.37.166.19"});</code></pre>

          <p>This is quite self-explanatory, as you will see below. However, <em>winston</em> can also do some pretty advanced stuff, I encourage you to read the documentation and go log-crazy ;)</p>

          <p>While I was at it, I cleaned the code a little bit and also solved the MongoDB ObjectId validation issue like this. Not sure if it's the canonical way, but it works.</p>

          <pre><code>// Check that the ObjectId is valid
try {
    oid = new require('mongodb').ObjectID.createFromHexString(query.id);
}
catch (err) {
    winston.info("Invalid OID, err="+err);
    response.end();
    return;
}</code></pre>

          <p>Here's the full code.</p>

          <pre><code>var http = require('http');
var url = require('url');
var mc = require('mc');
var winston = require('winston');
require('winston-syslogudp').Syslog;
function onRequest(request, response) {
        // No id parameter -->  do nothing
        // id=0 --> list all documents
        // id=SOME_OBJECT_ID --> show the 'x' value for this document
        var query = url.parse(request.url,true).query;
        winston.info("Request received, id="+query.id);
        if (query.id == null) {
                // No id parameter -->  do nothing
                response.end();
                return;
        }
        if (query.id == "0") {
                // id=0 --> list all documents
                collection.find().toArray(function (err, items) {
                        if (err) {
                                winston.error("Could not find all documents, err="+err);
                                response.end();
                                return;
                        }
                        winston.info("Finding all documents");
                        response.writeHead(200, {"Content-Type": "text/html"});
                        response.write("<html>");
                        for (var i = 0; i < items.length; i++) {
                                response.write(JSON.stringify(items[i])+"<br>");
                        }
                        response.write("</HTML>");
                        response.end();
                });
        }
        else {
                // Check that the ObjectId is valid
                try {
                        oid = new require('mongodb').ObjectID.createFromHexString(query.id);
                }
                catch (err) {
                        winston.info("Invalid OID, err="+err);
                        response.end();
                        return;
                }
                // id=SOME_OBJECT_ID --> show the 'x' value for this document
                // Check the cache first
                MemcacheClient.get(query.id, function(err, result) {
                if (!err) {
                        // Key found, display value
                        winston.info("Cache hit,  key="+query.id+", value="+result[query.id]);
                        response.writeHead(200, {"Content-Type": "text/html"});
                        response.write("<html>");
                        response.write("x="+result[query.id]);
                        response.write("</HTML>");
                        response.end();
                }
                else {
                        // Key not found, fetch value from DB
                        winston.info("Cache miss, key "+query.id+". Querying...");
                        collection.findOne({"_id": oid}, function (err, item) {
                                if ((err) || (item == null)) {
                                        winston.error("Could not query id "+query.id);
                                        response.end();
                                        return;
                                }
                                winston.info("Item found: "+JSON.stringify(item));
                                // Display value
                                response.writeHead(200, {"Content-Type": "text/html"});
                                response.write("<html>");
                                response.write(JSON.stringify(item));
                                response.write("</HTML>");
                                response.end();
                                // Store value in cache with a 60 second TTL
                                MemcacheClient.set(query.id, item.x, { flags: 0, exptime: 60}, function(err, status) {
                                        if (!err) {
                                                winston.info("Stored key="+query.id+", value="+item.x);
                                        }
                                        else {
                                                winston.error("Couldn't store key="+query.id+", error="+err);
                                        }
                                });
                        });
                }
                });
        }
}
// Program start
// Don't log to console
winston.remove(winston.transports.Console);
// Log to local file
winston.add(winston.transports.File, { filename: 'log.txt' });
// Log to remote syslog
winston.add(winston.transports.Syslog, {"host":"10.34.245.176", "port":"5140", "localhost":"10.37.166.19"});
winston.info("*** NODE APP STARTED ***");
// Connect to the ElastiCache cluster
MemcacheClient = new mc.Client(["memcache.9vficl.0001.euw1.cache.amazonaws.com", "memcache.9vficl.0002.euw1.cache.amazonaws.com"]);
MemcacheClient.connect(function() {
        winston.info("Connected to memcache");
});
// Connect to the MongoDB server hosted at MongoLab
var collection;
require('mongodb').MongoClient.connect("mongodb://USER:PASSWD@ds051067.mongolab.com:51067/mongolab-test", function(err, db) {
        if (!err) {
                winston.info("Connected to database");
                collection = db.collection("collection1");
        }
        else {
                winston.error("Dude, where's my DB?");
                process.exit(err);
        }
});
// Start the web server on port 8080 and wait for incoming requests
http.createServer(onRequest).listen(8080);
winston.info("Web server started");</code></pre>

          <p>Let's run this, hit it with some requests and look at the logs :)</p>

          <pre><code>ubuntu@ip-10-37-166-19:~$ <strong>node</strong> www5.js &amp;
ubuntu@ip-10-37-166-19:~$ <strong>tail</strong> -f log.txt
{"level":"info","message":"*** NODE APP STARTED ***","timestamp":"2013-08-05T15:07:36.678Z"}
{"level":"info","message":"Web server started","timestamp":"2013-08-05T15:07:36.823Z"}
{"level":"info","message":"Connected to memcache","timestamp":"2013-08-05T15:07:36.850Z"}
{"level":"info","message":"Connected to database","timestamp":"2013-08-05T15:07:36.876Z"}</code></pre>

          <pre><code>ubuntu@ip-10-34-245-176:~$ <strong>tail</strong> -f /var/log/messages
local0.info<134>: Aug  5 15:07:34 10.37.166.19 {"message":"*** NODE APP STARTED ***"}
local0.info<134>: Aug  5 15:07:34 10.37.166.19 {"message":"Web server started"}
local0.info<134>: Aug  5 15:07:34 10.37.166.19 {"message":"Connected to memcache"}
local0.info<134>: Aug  5 15:07:34 10.37.166.19 {"message":"Connected to database"}</code></pre>

          <p><strong>GET</strong> http://ec2-54-247-53-161.eu-west-1.compute.amazonaws.com:8080/?id=0</p>

          <pre><code>local0.info<134>: Aug  5 15:11:51 10.37.166.19 {"message":"Request received, id=0"}
local0.info<134>: Aug  5 15:11:51 10.37.166.19 {"message":"Finding all documents"}</code></pre>

          <p><strong>GET</strong> http://ec2-54-247-53-161.eu-west-1.compute.amazonaws.com:8080/?id=51e3ce08915082db3df32bf7</p>

          <pre><code>local0.info<134>: Aug  5 15:12:19 10.37.166.19 {"message":"Request received, id=51e3ce08915082db3df32bf7"}
local0.info<134>: Aug  5 15:12:19 10.37.166.19 {"message":"Cache miss, key 51e3ce08915082db3df32bf7. Querying..."}
local0.info<134>: Aug  5 15:12:19 10.37.166.19 {"message":"Item found: {\"_id\":\"51e3ce08915082db3df32bf7\",\"x\":8}"}
local0.info<134>: Aug  5 15:12:19 10.37.166.19 {"message":"Stored key=51e3ce08915082db3df32bf7, value=8"}</code></pre>

          <p>The same one, right away:</p>

          <pre><code>local0.info<134>: Aug  5 15:12:21 10.37.166.19 {"message":"Request received, id=51e3ce08915082db3df32bf7"}
local0.info<134>: Aug  5 15:12:21 10.37.166.19 {"message":"Cache hit,  key=51e3ce08915082db3df32bf7, value=8"}</code></pre>

          <p>The same one, more than 60 seconds later :)</p>

          <pre><code>local0.info<134>: Aug  5 15:14:15 10.37.166.19 {"message":"Request received, id=51e3ce08915082db3df32bf7"}
local0.info<134>: Aug  5 15:14:15 10.37.166.19 {"message":"Cache miss, key 51e3ce08915082db3df32bf7. Querying..."}
local0.info<134>: Aug  5 15:14:15 10.37.166.19 {"message":"Item found: {\"_id\":\"51e3ce08915082db3df32bf7. Querying..."}
local0.info<134>: Aug  5 15:14:15 10.37.166.19 {"message":"Stored key=51e3ce08915082db3df32bf7, value=8"}</code></pre>

          <p>Now, let's try a bogus ObjectID:</p>

          <p><strong>GET</strong> http://ec2-54-247-53-161.eu-west-1.compute.amazonaws.com:8080/?id=666</p>

          <pre><code>local0.info<134>: Aug  5 15:17:22 10.37.166.19 {"message":"Request received, id=666"}
local0.info<134>: Aug  5 15:17:22 10.37.166.19 {"message":"Invalid OID, err=Error: Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"}</code></pre>

          <p>Woohoo! This doesn't crash the app anymore. By the way, if you use Chrome, you certainly see a lot of annoying lines saying:</p>

          <pre><code>local0.info<134>: Aug  5 15:14:15 10.37.166.19 {"message":"Request received, id=undefined"}</code></pre>

          <p>You can ignore them: this is just Chrome trying over and over and over again to get the favorite icon (favicon.ico)... This is a <a href="https://code.google.com/p/chromium/issues/detail?id=39402">known bug</a>.</p>

          <p>And so now, our web app haz logz and at 131 lines of code (comments included), it's not bloated either. Pretty amazing.</p>

          <p>That's it for today. Keep hacking :)</p>
        </div>
      </article>
    </main>

    <footer>
      <nav>
        <a href="../../index.html">Home</a>
        <a href="../../experience.html">Experience</a>
        <a href="../../publications.html">Publications</a>
        <a href="../../code.html">Code</a>
        <a href="../../books.html">Books</a>
        <a href="../../youtube.html">YouTube</a>
        <a href="../../computers.html">Computers</a>
        <a href="../../legacy-posts.html">Legacy Posts</a>
      </nav>
    </footer>
  </div>

  <script src="../../js/main.js"></script>
</body>
</html>